%macro output_all(infile=, beg=,end=, outp2=);

proc import datafile = "&infile."
out = allq
dbms = csv replace;
getnames = yes;
guessingrows=max;
run;

proc sort data = allq;
by cp_id app_year app_month approved_dtm;
run;

data allq;
set allq;
app_date=app_year*100+app_month;
if (&beg.<=app_date<=&end.) then flagr=1;
by cp_id;
pfinalr=lag(final_grade);
final_standalone_grade=final_grade-standalone_grade;
run;

data allq(where=(flagr=1));
set allq;
run;

data rach2(keep=cp_id cp_name survey_id  final_grade standalone_grade final_standalone_grade flagr app_year app_month);
set allq;
run;

proc sort data = rach2;
by  app_year app_month ;
run;

data output.final_standalone;
set rach2;
run;

proc freq data=output.final_standalone;
table final_standalone_grade;
%mend;


%output_all(infile=&input\merge_sov_ratingchange.csv, beg=201707, end=201806,outp2=output.final_standalone);
